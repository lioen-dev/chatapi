<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Twitch Chat Overlay</title>
<style>
  body, html {
    margin:0; padding:0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: white;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #homepage, #chat-container {
    width: 90%;
    max-width: 600px;
    background: #222;
    border-radius: 8px;
    padding: 20px;
    box-sizing: border-box;
  }
  h1 {
    margin-top: 0;
    text-align: center;
  }
  label {
    display: block;
    margin: 12px 0 4px;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 8px;
    border: none;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 1rem;
  }
  button {
    margin-top: 16px;
    width: 100%;
    padding: 10px;
    font-size: 1.1rem;
    background: #9147ff;
    border: none;
    border-radius: 5px;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #772ce8;
  }
  #generated-url {
    margin-top: 12px;
    background: #333;
    padding: 10px;
    border-radius: 5px;
    font-size: 0.9rem;
    word-break: break-all;
  }
  #chat {
    padding: 10px;
    font-size: 1.2rem;
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 80vh;
    overflow-y: hidden;
    background: transparent;
    border-radius: 5px;
  }
  .message {
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div id="homepage" style="display:none;">
  <h1>Twitch Chat Overlay</h1>
  <p>
    This tool lets you display a Twitch channel's chat as a clean overlay in OBS or other streaming software.
  </p>
  <p>
    Just enter the Twitch username below and optionally choose background opacity. The tool will generate a URL you can add as a browser source in OBS.
  </p>
  <label for="username">Twitch Channel Username:</label>
  <input id="username" type="text" placeholder="e.g. twitchusername" autocomplete="off" />
  
  <label for="background">Background Opacity (0-100, optional):</label>
  <input id="background" type="number" min="0" max="100" placeholder="e.g. 0 for transparent, 10 for 10%" />
  
  <button id="generateBtn">Generate URL</button>
  
  <div id="generated-url" style="display:none;"></div>
</div>

<div id="chat-container" style="display:none; width:100vw; height:100vh; background: transparent;">
  <div id="chat"></div>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const channel = urlParams.get("channel");
  const bgParam = urlParams.get("background");

  const homepage = document.getElementById("homepage");
  const chatContainer = document.getElementById("chat-container");
  const chatBox = document.getElementById("chat");
  const generatedUrlDiv = document.getElementById("generated-url");

  if (!channel) {
    // Show homepage
    homepage.style.display = "block";

    document.getElementById("generateBtn").onclick = () => {
      const user = document.getElementById("username").value.trim();
      let bg = document.getElementById("background").value.trim();

      if (!user) {
        alert("Please enter a Twitch username.");
        return;
      }

      // Validate background opacity
      if (bg === "") {
        bg = null;
      } else {
        bg = parseInt(bg);
        if (isNaN(bg) || bg < 0 || bg > 100) {
          alert("Background opacity must be a number between 0 and 100.");
          return;
        }
      }

      // Build URL relative to current location
      let url = window.location.origin + window.location.pathname + `?channel=${encodeURIComponent(user)}`;
      if (bg !== null) {
        url += `&background=${bg}`;
      }

      generatedUrlDiv.style.display = "block";
      generatedUrlDiv.textContent = url;
      // Optionally select the URL for easy copying
      navigator.clipboard.writeText(url).catch(() => {}); // try copy silently
    };

  } else {
    // Show chat overlay
    homepage.style.display = "none";
    chatContainer.style.display = "flex";

    // Set background opacity
    if (bgParam === "none") {
      chatBox.style.background = "transparent";
    } else if (bgParam !== null && !isNaN(parseInt(bgParam))) {
      let opacity = Math.min(Math.max(parseInt(bgParam), 0), 100) / 100;
      chatBox.style.background = `rgba(0,0,0,${opacity})`;
    } else {
      chatBox.style.background = "transparent";
    }

    // Connect to Twitch IRC WebSocket
    const ws = new WebSocket("wss://irc-ws.chat.twitch.tv:443");

    ws.addEventListener("open", () => {
      console.log("WebSocket connected");
      ws.send("CAP REQ :twitch.tv/tags twitch.tv/commands twitch.tv/membership");
      ws.send("NICK justinfan12345"); // anonymous login
      ws.send(`JOIN #${channel.toLowerCase()}`);
    });

    ws.addEventListener("message", (event) => {
      const messages = event.data.split("\r\n").filter(line => line);
      for (const message of messages) {
        if (message.startsWith("PING")) {
          ws.send("PONG :tmi.twitch.tv");
          continue;
        }

        if (message.includes("PRIVMSG")) {
          const tagsPart = message.match(/^@([^ ]+) /);
          const tagsRaw = tagsPart ? tagsPart[1] : "";
          const tags = {};
          tagsRaw.split(";").forEach(pair => {
            const [key, val] = pair.split("=");
            tags[key] = val;
          });

          const nameMatch = message.match(/:(\w+)!\w+@\w+\.tmi\.twitch\.tv PRIVMSG #[^ ]+ :(.+)/);
          if (!nameMatch) continue;
          const username = tags["display-name"] || nameMatch[1];
          const text = nameMatch[2];

          console.log(`[${channel}] ${username}: ${text}`);

          const el = document.createElement("div");
          el.className = "message";
          el.innerHTML = `<strong style="color:${tags.color || "white"}">${username}</strong>: ${text}`;
          chatBox.appendChild(el);

          while (chatBox.children.length > 20) {
            chatBox.removeChild(chatBox.children[0]);
          }

          chatBox.scrollTop = chatBox.scrollHeight;
        }
      }
    });

    ws.addEventListener("close", () => {
      console.log("WebSocket closed");
    });

    ws.addEventListener("error", (err) => {
      console.error("WebSocket error:", err);
    });
  }
</script>
</body>
</html>
